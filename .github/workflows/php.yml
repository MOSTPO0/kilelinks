<?php
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
define('API_TOKEN', '7652259709:AAHaQKvu6LGFYBeG3cwpkTBWL1X3BGvoH-k');
define('ADMIN_ID', 8164533475); // Ø£ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø·ÙˆØ±
define('ACTIVATION_KEY', 'kilelinks1_&&&&69'); // Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„
define('ACTIVATION_DURATION', 3600); // Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ

// Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª)
$activated = false;
$activation_expiry = 0;
$waiting_for_button = false; // Ù‡Ù„ ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ø¨ÙˆØª Ø¥Ø¯Ø®Ø§Ù„ Ø²Ø± Ø¬Ø¯ÙŠØ¯ØŸ
$buttons = []; // Ù…ØµÙÙˆÙØ© ØªØ®Ø²Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
function sendMessage($chat_id, $text, $reply_markup = null) {
    $data = [
        'chat_id' => $chat_id,
        'text' => $text,
        'parse_mode' => 'HTML'
    ];
    
    if ($reply_markup) {
        $data['reply_markup'] = $reply_markup;
    }
    
    file_get_contents("https://api.telegram.org/bot" . API_TOKEN . "/sendMessage?" . http_build_query($data));
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø£Ø²Ø±Ø§Ø±
function createKeyboard() {
    global $buttons, $update;
    
    $keyboard = [];
    foreach ($buttons as $button) {
        $keyboard[] = [['text' => $button['text'], 'url' => $button['url']]];
    }
    
    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø·ÙˆØ±
    if ($update['message']['from']['id'] == ADMIN_ID) {
        $keyboard[] = [['text' => 'ðŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'callback_data' => 'stats']];
        $keyboard[] = [['text' => 'âž• Ø¥Ø¶Ø§ÙØ© Ø²Ø±', 'callback_data' => 'add_button']];
        $keyboard[] = [['text' => 'ðŸ“¢ Ù†Ø´Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹', 'callback_data' => 'broadcast']];
    }
    
    return json_encode(['inline_keyboard' => $keyboard]);
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
$update = json_decode(file_get_contents('php://input'), true);

if (isset($update['message'])) {
    $chat_id = $update['message']['chat']['id'];
    $user_id = $update['message']['from']['id'];
    $text = isset($update['message']['text']) ? $update['message']['text'] : '';
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙØ¹ÙŠÙ„
    if (!$activated || time() > $activation_expiry) {
        if ($text === ACTIVATION_KEY) {
            $activated = true;
            $activation_expiry = time() + ACTIVATION_DURATION;
            sendMessage($chat_id, "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©!", createKeyboard());
        } else {
            sendMessage($chat_id, "ðŸ” ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„:");
        }
    } else {
        // Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø²Ø± Ø¬Ø¯ÙŠØ¯
        global $waiting_for_button;
        if ($waiting_for_button && $user_id == ADMIN_ID) {
            $parts = explode("\n", $text);
            if (count($parts) >= 2) {
                $new_button = [
                    'text' => trim($parts[0]),
                    'url' => trim($parts[1])
                ];
                $buttons[] = $new_button;
                $waiting_for_button = false;
                sendMessage($chat_id, "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ø¨Ù†Ø¬Ø§Ø­:\nØ§Ù„Ù†Øµ: {$new_button['text']}\nØ§Ù„Ø±Ø§Ø¨Ø·: {$new_button['url']}", createKeyboard());
            } else {
                sendMessage($chat_id, "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØµØ­ÙŠØ­:\nÙ†Øµ Ø§Ù„Ø²Ø±\nØ±Ø§Ø¨Ø· Ø§Ù„Ø²Ø±");
            }
        } else {
            sendMessage($chat_id, "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡:", createKeyboard());
        }
    }
} elseif (isset($update['callback_query'])) {
    $data = $update['callback_query']['data'];
    $user_id = $update['callback_query']['from']['id'];
    $chat_id = $update['callback_query']['message']['chat']['id'];
    $message_id = $update['callback_query']['message']['message_id'];
    
    // ÙÙ‚Ø· Ø§Ù„Ù…Ø·ÙˆØ± ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    if ($user_id == ADMIN_ID) {
        if ($data == 'stats') {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            sendMessage($chat_id, "ðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª:\nØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†: " . count($buttons) * 10 . "\nØ§Ù„Ù†Ù‚Ø±Ø§Øª: " . count($buttons) * 50);
        } elseif ($data == 'add_button') {
            global $waiting_for_button;
            $waiting_for_button = true;
            sendMessage($chat_id, "âž• Ù„Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¬Ø¯ÙŠØ¯ØŒ Ø£Ø±Ø³Ù„:\nÙ†Øµ Ø§Ù„Ø²Ø±\nØ±Ø§Ø¨Ø· Ø§Ù„Ø²Ø±\n\nÙ…Ø«Ø§Ù„:\nÙ…ÙˆÙ‚Ø¹Ù†Ø§ Ø§Ù„Ø±Ø³Ù…ÙŠ\nhttps://example.com");
        } elseif ($data == 'broadcast') {
            sendMessage($chat_id, "ðŸ“¢ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ù†Ø´Ø±Ù‡Ø§ Ù„Ù„Ø¬Ù…ÙŠØ¹:");
        }
    }
    
    // Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ùƒallback Ø­ØªÙ‰ Ù„Ø§ ÙŠØ¸Ù‡Ø± "Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„" ÙÙŠ Ø§Ù„Ø¨ÙˆØª
    file_get_contents("https://api.telegram.org/bot" . API_TOKEN . "/answerCallbackQuery?callback_query_id=" . $update['callback_query']['id']);
}

// Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª)
if ($activated && time() > $activation_expiry) {
    $activated = false;
}

echo 'OK';
?>
